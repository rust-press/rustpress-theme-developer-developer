{% extends "layouts/base.html" %}

{% block title %}{{ post.title }} | {{ site.name }}{% endblock %}
{% block description %}{{ post.excerpt | striptags | truncate(length=160) }}{% endblock %}
{% block og_type %}article{% endblock %}
{% block og_image %}{{ post.featured_image }}{% endblock %}

{% block body_class %}page-single{% endblock %}

{% block reading_progress %}
<div class="reading-progress"></div>
{% endblock %}

{% block content %}
<article class="single-post" itemscope itemtype="https://schema.org/Article">
  {# Breadcrumbs #}
  {% if theme.breadcrumbs.enabled | default(value=true) %}
  <nav class="breadcrumbs container" aria-label="Breadcrumb">
    <a href="/">Home</a>
    <span class="separator">/</span>
    <a href="/blog">Blog</a>
    {% if post.category %}
    <span class="separator">/</span>
    <a href="{{ post.category.url }}">{{ post.category.name }}</a>
    {% endif %}
    <span class="separator">/</span>
    <span class="current">{{ post.title | truncate(length=50) }}</span>
  </nav>
  {% endif %}

  <div class="container">
    {# Post Header #}
    <header class="single-post-header">
      {% if post.category %}
      <a href="{{ post.category.url }}" class="single-post-category" itemprop="articleSection">{{ post.category.name }}</a>
      {% endif %}

      <h1 class="single-post-title" itemprop="headline">{{ post.title }}</h1>

      <div class="single-post-meta">
        <span class="meta-author" itemprop="author" itemscope itemtype="https://schema.org/Person">
          {% if post.author.avatar %}
          <img src="{{ post.author.avatar }}" alt="{{ post.author.name }}" class="author-avatar-sm">
          {% endif %}
          <a href="{{ post.author.url }}" itemprop="name">{{ post.author.name }}</a>
        </span>
        <span class="meta-date">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          <time datetime="{{ post.date | date(format='%Y-%m-%d') }}" itemprop="datePublished">{{ post.date | date(format='%B %d, %Y') }}</time>
        </span>
        <span class="meta-reading-time">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
          {{ post.reading_time }} min read
        </span>
        {% if post.views %}
        <span class="meta-views">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          {{ post.views }} views
        </span>
        {% endif %}
      </div>
    </header>

    {# Featured Image #}
    {% if post.featured_image %}
    <figure class="single-post-featured-image">
      <img src="{{ post.featured_image }}" alt="{{ post.title }}" itemprop="image" loading="eager">
      {% if post.featured_image_caption %}
      <figcaption>{{ post.featured_image_caption }}</figcaption>
      {% endif %}
    </figure>
    {% endif %}

    {# Content Area with optional sidebar #}
    <div class="single-post-layout {% if theme.single.show_sidebar | default(value=false) %}single-post-layout--with-sidebar{% endif %}">
      <div class="single-post-main">
        {# Table of Contents (optional) #}
        {% if theme.single.show_table_of_contents | default(value=true) and post.toc | length > 0 %}
        <nav class="table-of-contents" aria-label="Table of contents">
          <div class="toc-title">
            <span>Table of Contents</span>
            <button class="toc-toggle" aria-label="Toggle table of contents">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
          </div>
          <ol class="toc-list">
            {% for item in post.toc %}
            <li class="toc-{{ item.level }}">
              <a href="#{{ item.id }}">{{ item.text }}</a>
            </li>
            {% endfor %}
          </ol>
        </nav>
        {% endif %}

        {# Post Content #}
        <div class="single-post-content" itemprop="articleBody">
          {{ post.content | safe }}
        </div>

        {# Post Tags #}
        {% if post.tags | length > 0 %}
        <div class="single-post-tags">
          <span class="tags-label">Tags:</span>
          {% for tag in post.tags %}
          <a href="{{ tag.url }}" rel="tag">{{ tag.name }}</a>
          {% endfor %}
        </div>
        {% endif %}

        {# Social Share #}
        {% if theme.single.show_social_share | default(value=true) %}
        <div class="social-share">
          <span class="social-share-label">Share this article:</span>
          <div class="social-share-buttons">
            <a href="https://www.facebook.com/sharer/sharer.php?u={{ post.url | urlencode }}" target="_blank" rel="noopener" class="social-share-btn social-share-btn--facebook" aria-label="Share on Facebook">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
            </a>
            <a href="https://twitter.com/intent/tweet?url={{ post.url | urlencode }}&text={{ post.title | urlencode }}" target="_blank" rel="noopener" class="social-share-btn social-share-btn--twitter" aria-label="Share on Twitter">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
            </a>
            <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ post.url | urlencode }}&title={{ post.title | urlencode }}" target="_blank" rel="noopener" class="social-share-btn social-share-btn--linkedin" aria-label="Share on LinkedIn">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
            </a>
            <a href="https://pinterest.com/pin/create/button/?url={{ post.url | urlencode }}&description={{ post.title | urlencode }}" target="_blank" rel="noopener" class="social-share-btn social-share-btn--pinterest" aria-label="Share on Pinterest">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.627 0-12 5.372-12 12 0 5.084 3.163 9.426 7.627 11.174-.105-.949-.2-2.405.042-3.441.218-.937 1.407-5.965 1.407-5.965s-.359-.719-.359-1.782c0-1.668.967-2.914 2.171-2.914 1.023 0 1.518.769 1.518 1.69 0 1.029-.655 2.568-.994 3.995-.283 1.194.599 2.169 1.777 2.169 2.133 0 3.772-2.249 3.772-5.495 0-2.873-2.064-4.882-5.012-4.882-3.414 0-5.418 2.561-5.418 5.207 0 1.031.397 2.138.893 2.738.098.119.112.224.083.345l-.333 1.36c-.053.22-.174.267-.402.161-1.499-.698-2.436-2.889-2.436-4.649 0-3.785 2.75-7.262 7.929-7.262 4.163 0 7.398 2.967 7.398 6.931 0 4.136-2.607 7.464-6.227 7.464-1.216 0-2.359-.631-2.75-1.378l-.748 2.853c-.271 1.043-1.002 2.35-1.492 3.146 1.124.347 2.317.535 3.554.535 6.627 0 12-5.373 12-12 0-6.628-5.373-12-12-12z"/></svg>
            </a>
            <a href="mailto:?subject={{ post.title | urlencode }}&body={{ post.url | urlencode }}" class="social-share-btn social-share-btn--email" aria-label="Share via Email">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
            </a>
          </div>
        </div>
        {% endif %}

        {# Author Box #}
        {% if theme.single.show_author_box | default(value=true) and post.author %}
        <div class="author-box">
          <img src="{{ post.author.avatar | default(value='/images/default-avatar.jpg') }}" alt="{{ post.author.name }}" class="author-box-avatar">
          <div class="author-box-info">
            <span class="author-box-label">Written by</span>
            <h4 class="author-box-name">
              <a href="{{ post.author.url }}">{{ post.author.name }}</a>
            </h4>
            {% if post.author.role %}
            <span class="author-box-role">{{ post.author.role }}</span>
            {% endif %}
            <p class="author-box-bio">{{ post.author.bio | default(value='The author has not provided a bio yet.') }}</p>
            {% if post.author.social %}
            <div class="author-box-social">
              {% if post.author.social.twitter %}
              <a href="{{ post.author.social.twitter }}" target="_blank" rel="noopener" aria-label="Twitter">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
              </a>
              {% endif %}
              {% if post.author.social.linkedin %}
              <a href="{{ post.author.social.linkedin }}" target="_blank" rel="noopener" aria-label="LinkedIn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
              </a>
              {% endif %}
              {% if post.author.social.website %}
              <a href="{{ post.author.social.website }}" target="_blank" rel="noopener" aria-label="Website">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
              </a>
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}

        {# Post Navigation #}
        {% if theme.single.show_prev_next | default(value=true) %}
        <nav class="post-navigation" aria-label="Post navigation">
          {% if post.prev %}
          <a href="{{ post.prev.url }}" class="nav-prev">
            <span class="nav-label">← Previous Article</span>
            <span class="nav-title">{{ post.prev.title | truncate(length=60) }}</span>
          </a>
          {% else %}
          <div class="nav-prev nav-empty"></div>
          {% endif %}

          {% if post.next %}
          <a href="{{ post.next.url }}" class="nav-next">
            <span class="nav-label">Next Article →</span>
            <span class="nav-title">{{ post.next.title | truncate(length=60) }}</span>
          </a>
          {% endif %}
        </nav>
        {% endif %}

        {# Related Posts #}
        {% if theme.single.show_related_posts | default(value=true) and related_posts | length > 0 %}
        <section class="related-posts">
          <h2 class="related-posts-title">You May Also Like</h2>
          <div class="related-posts-grid">
            {% for related in related_posts | slice(end=3) %}
            <article class="card">
              <a href="{{ related.url }}" class="card-image">
                <img src="{{ related.featured_image | default(value='/images/placeholder-card.jpg') }}" alt="{{ related.title }}" loading="lazy">
              </a>
              <div class="card-content">
                <div class="card-meta">
                  <span>{{ related.date | date(format='%B %d, %Y') }}</span>
                </div>
                <h3 class="card-title">
                  <a href="{{ related.url }}">{{ related.title }}</a>
                </h3>
              </div>
            </article>
            {% endfor %}
          </div>
        </section>
        {% endif %}

        {# Comments #}
        {% if theme.single.show_comments | default(value=true) %}
        <section class="comments-section" id="comments">
          <h2 class="comments-title">
            Comments
            {% if post.comments_count > 0 %}({{ post.comments_count }}){% endif %}
          </h2>

          {% if post.comments | length > 0 %}
          <ol class="comment-list">
            {% for comment in post.comments %}
            <li class="comment" id="comment-{{ comment.id }}">
              <div class="comment-header">
                <img src="{{ comment.author_avatar | default(value='/images/default-avatar.jpg') }}" alt="{{ comment.author_name }}" class="comment-avatar">
                <div>
                  <span class="comment-author">{{ comment.author_name }}</span>
                  <span class="comment-date">{{ comment.date | date(format='%B %d, %Y at %H:%M') }}</span>
                </div>
              </div>
              <div class="comment-content">
                {{ comment.content | safe }}
              </div>
              <a href="#comment-form" class="comment-reply" data-reply-to="{{ comment.id }}">Reply</a>

              {% if comment.children | length > 0 %}
              <ol class="comment-children">
                {% for child in comment.children %}
                <li class="comment" id="comment-{{ child.id }}">
                  <div class="comment-header">
                    <img src="{{ child.author_avatar | default(value='/images/default-avatar.jpg') }}" alt="{{ child.author_name }}" class="comment-avatar">
                    <div>
                      <span class="comment-author">{{ child.author_name }}</span>
                      <span class="comment-date">{{ child.date | date(format='%B %d, %Y at %H:%M') }}</span>
                    </div>
                  </div>
                  <div class="comment-content">
                    {{ child.content | safe }}
                  </div>
                </li>
                {% endfor %}
              </ol>
              {% endif %}
            </li>
            {% endfor %}
          </ol>
          {% endif %}

          {# Comment Form #}
          <div class="comment-form" id="comment-form">
            <h3 class="comment-form-title">Leave a Comment</h3>
            <form action="/api/comments" method="post">
              <input type="hidden" name="post_id" value="{{ post.id }}">
              <input type="hidden" name="parent_id" id="parent_id" value="">

              <div class="form-group">
                <label for="comment_name" class="form-label">Name *</label>
                <input type="text" id="comment_name" name="name" class="form-input" required>
              </div>

              <div class="form-group">
                <label for="comment_email" class="form-label">Email *</label>
                <input type="email" id="comment_email" name="email" class="form-input" required>
              </div>

              <div class="form-group">
                <label for="comment_content" class="form-label">Comment *</label>
                <textarea id="comment_content" name="content" class="form-textarea" rows="5" required></textarea>
              </div>

              <div class="form-check">
                <input type="checkbox" id="save_info" name="save_info" class="form-check-input">
                <label for="save_info" class="form-check-label">Save my name and email for next time</label>
              </div>

              <button type="submit" class="btn btn--primary">Post Comment</button>
            </form>
          </div>
        </section>
        {% endif %}
      </div>

      {# Sidebar (optional for single posts) #}
      {% if theme.single.show_sidebar | default(value=false) %}
      {% include "partials/sidebar.html" %}
      {% endif %}
    </div>
  </div>
</article>
{% endblock %}

{% block scripts %}
<style>
/* Single Post Layout */
.single-post-layout {
  display: block;
}

.single-post-layout--with-sidebar {
  display: grid;
  grid-template-columns: 1fr var(--sidebar-width);
  gap: var(--space-8);
}

.single-post-main {
  min-width: 0;
}

/* Reading Progress */
.reading-progress {
  position: fixed;
  top: 0;
  left: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
  width: 0;
  z-index: 9999;
  transition: width 0.1s ease;
}

/* Meta Styles */
.author-avatar-sm {
  width: 24px;
  height: 24px;
  border-radius: var(--radius-full);
  margin-right: var(--space-2);
}

.meta-author {
  display: flex;
  align-items: center;
}

.meta-author a {
  color: var(--text-primary);
  font-weight: var(--font-medium);
}

/* Author Box Label */
.author-box-label {
  font-size: var(--text-xs);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-tertiary);
  margin-bottom: var(--space-1);
  display: block;
}

/* Tags Label */
.tags-label {
  font-weight: var(--font-medium);
  margin-right: var(--space-2);
}

/* Responsive */
@media (max-width: 1024px) {
  .single-post-layout--with-sidebar {
    grid-template-columns: 1fr;
  }
}
</style>
{% endblock %}
